# Plena Project Snapshot

**Timestamp:** December 5, 2025 - 12:19:39
**Purpose:** Pre-optimization snapshot with analysis findings

---

## Project Status

### Current Features

#### ✅ Implemented & Working

1. **Meditation Session Tracking**

   - Start/stop sessions with 3-2-1 countdown
   - Real-time sensor data collection (HR, HRV, Respiratory Rate, VO₂ Max, Temperature)
   - Session summaries
   - Local storage via CoreDataStorageService

2. **HealthKit Integration**

   - Read sensor data in real-time
   - Save mindful sessions to HealthKit on completion
   - Query historical mindful sessions
   - VO₂ Max and Temperature baseline tracking

3. **Dashboard**

   - Session statistics and trends
   - Duration trend charts
   - Session frequency charts
   - Stat cards with key metrics

4. **Data Visualization**

   - Time range selection (Day/Week/Month/Year)
   - Sensor type selection (Heart Rate/HRV/Respiratory Rate/VO₂ Max/Temperature)
   - Charts with trend indicators
   - Date-range optimized loading
   - Smart axis label formatting

5. **Settings System**

   - Sensor toggle controls (Heart Rate, HRV, Respiratory Rate, VO₂ Max, Temperature)
   - Temperature unit preference (Celsius/Fahrenheit)
   - Settings sync between iOS and Watch via iCloud Key-Value Store

6. **Apple Watch Integration**

   - Start/Stop meditation sessions with 3-2-1 countdown
   - Display sensors with scrolling
   - Respects settings from iPhone
   - Temperature unit conversion

7. **Test Data Generation** (Debug only)
   - TestDataView for generating realistic test sessions
   - TestDataGenerator service
   - HRV insights test data generation

### Architecture

- **MVVM Pattern**: Separation of concerns with ViewModels
- **SwiftUI**: Modern declarative UI framework
- **Core Data**: Data persistence (via CoreDataStorageService)
- **HealthKit**: Health and fitness data integration
- **iCloud Key-Value Store**: Settings synchronization
- **Dependency Injection**: Testable components
- **Async/Await**: Modern concurrency patterns

---

## Project Structure

```
Plena/
├── Plena/                          # iOS App
│   ├── PlenaApp.swift             # App entry point
│   ├── ContentView.swift          # Tab navigation (5 tabs)
│   ├── Views/
│   │   ├── MeditationSessionView.swift
│   │   ├── DashboardView.swift
│   │   ├── DataVisualizationView.swift
│   │   ├── SettingsView.swift
│   │   ├── TestDataView.swift     # Debug only
│   │   ├── SessionSummaryView.swift
│   │   ├── GraphView.swift
│   │   ├── AxisLabelSettingsView.swift
│   │   └── Components/
│   │       ├── StatCard.swift
│   │       ├── DurationTrendChart.swift
│   │       └── SessionFrequencyChart.swift
│   └── Plena.entitlements        # iCloud configured
│
├── Plena Watch App/               # watchOS App
│   ├── PlenaWatchApp.swift
│   ├── WatchContentView.swift
│   └── Views/
│       └── MeditationWatchView.swift
│
└── PlenaShared/                   # Shared code
    ├── Models/
    │   ├── MeditationSession.swift
    │   ├── HeartRateSample.swift
    │   ├── HRVSample.swift
    │   ├── RespiratoryRateSample.swift
    │   ├── VO2MaxSample.swift
    │   ├── TemperatureSample.swift
    │   ├── StateOfMindLog.swift
    │   └── SessionSummary.swift
    ├── Services/
    │   ├── HealthKitService.swift
    │   ├── HealthKitImportService.swift      # ⚠️ Not used
    │   ├── CoreDataStorageService.swift     # ✅ Active
    │   ├── SwiftDataStorageService.swift    # ⚠️ Not used
    │   ├── SessionStorageService.swift      # ⚠️ Fallback only
    │   ├── TestDataGenerator.swift
    │   └── CoreDataStack.swift
    └── ViewModels/
        ├── MeditationSessionViewModel.swift
        ├── DashboardViewModel.swift
        ├── DataVisualizationViewModel.swift
        ├── SettingsViewModel.swift
        ├── PlenaTimeAxisLabels.swift        # ⚠️ Performance issue
        ├── SmartAxisLabelFormatter.swift
        ├── AxisLabelImplementation.swift
        ├── SensorTypes.swift
        └── TimeRange.swift
```

---

## Code Analysis Findings

### ⚠️ Unused Code (Safe to Remove)

1. **SwiftDataStorageService.swift**

   - Status: Not used anywhere in the app
   - App uses CoreDataStorageService instead
   - Recommendation: Remove to reduce codebase size

2. **HealthKitImportService.swift**
   - Status: Defined but not referenced in any views/ViewModels
   - Recommendation: Remove if not planned for future use, or document as future feature

### ⚠️ Partially Used Code

1. **SessionStorageService.swift**
   - Status: Only used as fallback in PlenaApp.swift and SwiftDataStorageService migration
   - Recommendation: Keep if migration not complete, otherwise remove

### ⚠️ Performance Issues

1. **PlenaTimeAxisLabels.swift**

   - Issue: Creates new DateFormatter instances repeatedly (lines 90-94, 117-119, 160-164)
   - Impact: Unnecessary allocations on every view update
   - Recommendation: Cache DateFormatter instances as static properties

2. **HealthKitService.swift**
   - Issue: Force unwraps for HealthKit types (lines 51-56)
   - Impact: Potential crashes if HealthKit types unavailable
   - Recommendation: Add safety checks with proper error handling

### ⚠️ Test Coverage Gaps

#### Existing Tests

- `Tests/HealthKitServiceVO2MaxTemperatureTests.swift` - Has tests but relies on real HealthKit (needs mocking)
- `Tests/MeditationSessionViewModelSampleCollectionTests.swift` - Has mocks but incomplete coverage

#### Missing Tests

- `DashboardViewModel` - No tests
- `DataVisualizationViewModel` - No tests
- `SettingsViewModel` - No tests
- `PlenaTimeAxisLabels` - No tests
- `CoreDataStorageService` - No tests
- `TestDataGenerator` - No tests

### ✅ Good Practices Found

1. TestDataView properly wrapped in `#if DEBUG`
2. Dependency injection used throughout
3. Protocol-based architecture for testability
4. Proper async/await usage
5. MVVM pattern consistently applied

---

## Current Tab Structure

```swift
TabView {
    Tab 0: Meditation Session (MeditationSessionView)
    Tab 1: Dashboard (DashboardView)
    Tab 2: Data Visualization (DataVisualizationView)
    Tab 3: Test Data (TestDataView) - #if DEBUG only
    Tab 4: Settings (SettingsView)
}
```

---

## Storage Services Status

### Active

- **CoreDataStorageService** - Primary storage service, used throughout app

### Unused

- **SwiftDataStorageService** - Not used, can be removed

### Fallback

- **SessionStorageService** - JSON-based fallback, used in PlenaApp.swift initialization

---

## Optimization Recommendations

### High Priority

1. ✅ Remove unused `SwiftDataStorageService.swift`
2. ✅ Optimize `PlenaTimeAxisLabels` (cache DateFormatters)
3. ✅ Improve HealthKit service safety (remove force unwraps)

### Medium Priority

4. Add missing tests for ViewModels
5. Remove or document `HealthKitImportService` if unused
6. Improve test mocking for HealthKit-dependent tests

### Low Priority

7. Add tests for `TestDataGenerator`
8. Add tests for `CoreDataStorageService`
9. Clean up `SessionStorageService` if migration complete

---

## Key Files & Their Status

### Views

- ✅ `MeditationSessionView.swift` - Working
- ✅ `DashboardView.swift` - Working
- ✅ `DataVisualizationView.swift` - Working
- ✅ `SettingsView.swift` - Working
- ✅ `TestDataView.swift` - Working (Debug only)
- ✅ `GraphView.swift` - Working
- ✅ `SessionSummaryView.swift` - Working

### ViewModels

- ✅ `MeditationSessionViewModel.swift` - Working
- ✅ `DashboardViewModel.swift` - Working
- ✅ `DataVisualizationViewModel.swift` - Working
- ✅ `SettingsViewModel.swift` - Working
- ⚠️ `PlenaTimeAxisLabels.swift` - Performance issue (DateFormatter creation)

### Services

- ✅ `HealthKitService.swift` - Working (has force unwraps)
- ⚠️ `HealthKitImportService.swift` - Not used
- ✅ `CoreDataStorageService.swift` - Active
- ⚠️ `SwiftDataStorageService.swift` - Unused
- ⚠️ `SessionStorageService.swift` - Fallback only
- ✅ `TestDataGenerator.swift` - Working

### Models

- ✅ All models working correctly

---

## Settings Sync Implementation

**Method:** iCloud Key-Value Store (NSUbiquitousKeyValueStore)

- No App Groups setup required
- Already configured in entitlements
- Automatic sync between iOS and Watch
- Polling interval: 2 seconds (backup mechanism)
- Notification-based updates for real-time sync

**Settings Stored:**

- `sensorHeartRateEnabled` (Bool)
- `sensorHRVEnabled` (Bool)
- `sensorRespiratoryRateEnabled` (Bool)
- `sensorVO2MaxEnabled` (Bool)
- `sensorTemperatureEnabled` (Bool)
- `temperatureUnit` (String: "°C" or "°F")

---

## Testing Status

### Test Files

- `Tests/HealthKitServiceVO2MaxTemperatureTests.swift` - Needs mocking improvements
- `Tests/MeditationSessionViewModelSampleCollectionTests.swift` - Has mocks, incomplete coverage

### Missing Test Coverage

- DashboardViewModel
- DataVisualizationViewModel
- SettingsViewModel
- PlenaTimeAxisLabels
- CoreDataStorageService
- TestDataGenerator

---

## Known Issues

1. **Performance**: DateFormatter recreation in PlenaTimeAxisLabels
2. **Safety**: Force unwraps in HealthKitService
3. **Test Coverage**: Missing tests for several ViewModels
4. **Unused Code**: SwiftDataStorageService and HealthKitImportService not used

---

## Next Steps (Post-Snapshot)

1. Remove unused code (SwiftDataStorageService, HealthKitImportService if not needed)
2. Optimize PlenaTimeAxisLabels (cache DateFormatters)
3. Improve HealthKit service safety
4. Add missing tests
5. Improve existing test mocking

---

**Snapshot Created:** December 5, 2025 - 12:19:39
**Project Version:** Pre-Optimization State
**Status:** All features working, optimization opportunities identified


